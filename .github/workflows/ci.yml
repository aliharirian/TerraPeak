name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.25

    - name: Download dependencies
      run: |
        cd registry
        go mod download
        go mod verify

    - name: Run tests
      run: |
        cd registry
        go test -v -race ./...

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.25

    - name: Build release binaries
      run: |
        cd registry
        mkdir -p ../dist

        # Build for multiple platforms
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o ../dist/terrapeak-linux-amd64 .
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o ../dist/terrapeak-linux-arm64 .
        GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o ../dist/terrapeak-darwin-amd64 .
        GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o ../dist/terrapeak-darwin-arm64 .

    - name: Create checksums
      run: |
        cd dist
        sha256sum * > checksums.txt

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install semantic-release
      run: |
        npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github

    - name: Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: npx semantic-release


  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build multi-arch Docker image
      uses: docker/build-push-action@v4
      with:
        context: registry
        file: registry/Dockerfile
        platforms: linux/amd64,linux/arm64,darwin/amd64,darwin/arm64
        push: false
        tags: terrapeak:latest
